const node = await import('node:child_process')

/**
 * Running tsc on types is extremely sensible to node_modules types that we import and there is no way to exclude them.
 * Note: Yes, we try `--exclude` and it is not excluding them.
 * So this script just excludes expected errors but still allows to validate the types we release thoroughly
 */

// List of paths to exclude (relative or absolute, as needed)
const excludeList = [
    'node_modules/@types/node/url.d.ts',
    'node_modules/urlpattern-polyfill/dist/index.d.ts',
    'node_modules/webdriverio/build/commands/browser/getPuppeteer.d.ts',
    'node_modules/webdriverio/build/types.d.ts',
    // Add more paths or patterns as needed
]

node.exec('tsc --project tsconfig.types.json --noEmit', (error, stdout, stderr) => {
    const output = stdout + stderr
    const lines = output.split('\n')
    let found = false

    for (const line of lines) {
        // Check if the line matches any exclusion pattern
        const shouldExclude = excludeList.some(excludePath =>
            line.trim().startsWith(excludePath)
        )
        if (!shouldExclude && line.includes('error TS')) {
            found = true
            console.log(line)
        }
    }

    if (!found) {
        console.log('No type errors outside the exclusion list.')
    } else {
        console.error('\nERROR: Type errors found please fix them as much as possible or exclude them in the script `types-checks-filter-out-node_modules.js`')
        process.exit(1)
    }
})